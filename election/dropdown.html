<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hierarchical PS Selector & Candidate Viewer</title>
    <!-- Include SheetJS library -->
    <script lang="javascript" src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f4; }
        .container { background: #fff; padding: 20px; border-radius: 8px; max-width: 800px; margin: auto; }
        .loader { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
        #googleSheetUrl { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .button { padding: 8px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .button:disabled { background-color: #ccc; cursor: not-allowed; }
        .button:hover:not(:disabled) { background-color: #0056b3; }
        .dropdown-container { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        label { margin-bottom: 5px; font-weight: bold; }
        select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; width: 100%; }
        select:disabled { background-color: #e9ecef; }
        #status { margin-top: 15px; font-style: italic; color: #555; }
        .hidden { display: none; }

        /* Styles for Candidate Display Area */
        #candidateDisplay {
            margin-top: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        #candidateDisplay h2 {
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            font-size: 1.2em;
        }
        .candidate-columns {
            display: flex;
            gap: 20px;
            justify-content: space-around; /* Distribute columns */
        }
        .candidate-column {
            flex: 1; /* Allow columns to grow equally */
            min-width: 150px; /* Prevent columns from becoming too narrow */
        }
        .candidate-column h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1em;
            color: #333;
        }
        .candidate-list {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 0.9em;
        }
        .candidate-list li {
            padding: 4px 0;
            border-bottom: 1px dashed #eee;
        }
        .candidate-list li:last-child {
            border-bottom: none;
        }
        .candidate-list .uncontested {
            font-style: italic;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Polling Station Selector</h1>

        <div class="loader">
            <input type="text" id="googleSheetUrl" placeholder="Paste Google Sheet 'Publish to web' CSV Link...">
            <button id="loadFromUrlButton" class="button">Load Data</button>
        </div>
        <div id="status">Enter a Google Sheet URL and click 'Load Data'.</div>

        <div class="status-switch-container">
            <span id="statusLabel">No data loaded.</span>
            <!-- <button id="switchViewButton" class="button">Switch to Contestant View</button> -->
            <a href="/"><button class="button">Switch to Ballot View</button></a>
        </div>

        <div class="dropdown-container">
            <div>
                <label for="zpcSelect">ZPC Name:</label>
                <select id="zpcSelect" disabled>
                    <option value="">-- Select ZPC --</option>
                </select>
            </div>
            <div>
                <label for="apSelect">AP Name:</label>
                <select id="apSelect" disabled>
                    <option value="">-- Select AP --</option>
                </select>
            </div>
            <div>
                <label for="gpSelect">GP Name:</label>
                <select id="gpSelect" disabled>
                    <option value="">-- Select GP --</option>
                </select>
            </div>
            <div>
                <label for="wardSelect">Ward Name:</label>
                <select id="wardSelect" disabled>
                    <option value="">-- Select Ward --</option>
                </select>
            </div>
            <div>
                <label for="psSelect">PS Name:</label>
                <select id="psSelect" disabled>
                    <option value="">-- Select PS --</option>
                </select>
            </div>
        </div>

        <!-- Candidate Display Area (Initially Hidden) -->
        <div id="candidateDisplay" class="hidden">
             <h2>Candidates for Selected PS</h2>
             <div class="candidate-columns">
                <div class="candidate-column">
                    <h3>ZPC Candidates</h3>
                    <ul id="zpcCandidateList" class="candidate-list"></ul>
                </div>
                <div class="candidate-column">
                    <h3>AP Candidates</h3>
                    <ul id="apCandidateList" class="candidate-list"></ul>
                </div>
                <div class="candidate-column">
                    <h3>Ward Candidates</h3>
                    <ul id="wardCandidateList" class="candidate-list"></ul>
                </div>
            </div>
        </div>
        <!-- End Candidate Display Area -->

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const urlInput = document.getElementById('googleSheetUrl');
            const loadButton = document.getElementById('loadFromUrlButton');
            const statusLabel = document.getElementById('status');
            const zpcSelect = document.getElementById('zpcSelect');
            const apSelect = document.getElementById('apSelect');
            const gpSelect = document.getElementById('gpSelect');
            const wardSelect = document.getElementById('wardSelect');
            const psSelect = document.getElementById('psSelect');

            // Candidate Display Elements
            const candidateDisplayDiv = document.getElementById('candidateDisplay');
            const zpcCandidateList = document.getElementById('zpcCandidateList');
            const apCandidateList = document.getElementById('apCandidateList');
            const wardCandidateList = document.getElementById('wardCandidateList');

            // --- Global State ---
            let rawData = [];
            let hierarchy = new Map(); // Map<zpc, Map<ap, Map<gp, Map<ward, Set<ps>>>>>
            let psCandidateData = new Map(); // Map<formattedPsName, {zpc: [], ap: [], ward: []}>
            let headerMap = {}; // To store actual header names found

            // --- Constants ---
            const ZPC_KEY = 'zpc name';
            const AP_KEY = 'ap name';
            const GP_KEY = 'gp name';
            const WARD_KEY = 'ward name';
            const PS_KEY = 'ps name';
            const ZPC_NO_KEY = 'zpc no.';
            const AP_NO_KEY = 'ap no.';
            const GP_NO_KEY = 'gp no.';
            const WARD_NO_KEY = 'ward no.';
            const PS_NO_KEY = 'ps no.';
            // Add candidate prefixes (ensure these match your sheet headers *start*)
            const ZPC_CANDIDATE_PREFIX = 'ZPM';
            const AP_CANDIDATE_PREFIX = 'APM';
            const WARD_CANDIDATE_PREFIX = 'GPM';

            const REQ_KEYS = [
                ZPC_KEY, AP_KEY, GP_KEY, WARD_KEY, PS_KEY,
                ZPC_NO_KEY, AP_NO_KEY, GP_NO_KEY, WARD_NO_KEY, PS_NO_KEY
            ];
            // Note: Candidate columns are not strictly required for the dropdowns,
            // but are required for the candidate display feature. Add checks if needed.

            // --- Event Listeners ---
            loadButton.addEventListener('click', handleUrlLoad);
            zpcSelect.addEventListener('change', handleZpcChange);
            apSelect.addEventListener('change', handleApChange);
            gpSelect.addEventListener('change', handleGpChange);
            wardSelect.addEventListener('change', handleWardChange);
            psSelect.addEventListener('change', handlePsSelectChange); // Listener for the final PS dropdown

            // --- Utility Functions ---
            function findHeaderKey(headers, targetKey) {
                const lowerTarget = targetKey.toLowerCase().trim();
                for (const header of headers) {
                    if (String(header).toLowerCase().trim() === lowerTarget) {
                        return header; // Return the exact header name found
                    }
                }
                return null; // Not found
            }

            function populateDropdown(selectElement, options, placeholder) {
                selectElement.innerHTML = `<option value="">-- ${placeholder} --</option>`; // Clear existing options
                options.sort((a, b) => a.localeCompare(b)); // Sort options alphabetically
                options.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.textContent = option;
                    selectElement.appendChild(opt);
                });
                selectElement.disabled = options.length === 0; // Disable if no options
            }

            function resetDropdown(selectElement, placeholder) {
                 selectElement.innerHTML = `<option value="">-- ${placeholder} --</option>`;
                 selectElement.disabled = true;
                 selectElement.value = ""; // Reset selection
            }

            function resetAllDropdowns() {
                resetDropdown(zpcSelect, 'Select ZPC');
                resetDropdown(apSelect, 'Select AP');
                resetDropdown(gpSelect, 'Select GP');
                resetDropdown(wardSelect, 'Select Ward');
                resetDropdown(psSelect, 'Select PS');
                clearAndHideCandidates(); // Also reset candidate display
            }

             function setLoadingState(loading) {
                loadButton.disabled = loading;
                urlInput.disabled = loading;
                if (loading) {
                    statusLabel.textContent = 'Loading data...';
                    resetAllDropdowns(); // Disable dropdowns and clear candidates while loading
                } else {
                    // Status will be updated on success/error
                }
             }

            // --- Candidate Helper Functions ---
            // Copied from script.js
            function getCandidateNamesJS(row, prefix) {
                const candidates = [];
                if (!row) return candidates;
                // Find actual header keys that *start with* the prefix (case-insensitive)
                const matchingHeaders = Object.keys(row).filter(key =>
                    typeof key === 'string' && key.trim().toLowerCase().startsWith(prefix.toLowerCase())
                );

                // Sort matching headers to maintain a consistent order if needed (e.g., ZPM1, ZPM2)
                // This simple sort works if headers are like 'ZPM1', 'ZPM10', 'ZPM2'
                // A more robust natural sort might be needed for complex cases.
                matchingHeaders.sort();

                for (const key of matchingHeaders) {
                    let value = row[key];
                    if (value !== null && value !== undefined) {
                        const strValue = String(value).trim();
                        // Consider 'nil', 'NIL', 'Nil', etc. as non-candidates
                        if (strValue && strValue.toLowerCase() !== 'nil') {
                            candidates.push(strValue);
                        }
                    }
                }
                return candidates;
            }

            // Helper to format No - Name, handling missing parts
            function formatNoName(no, name) {
                const numStr = String(no || '').trim();
                const nameStr = String(name || '').trim();

                if (numStr && nameStr) {
                    // Standardize the separator
                    return `${numStr} - ${nameStr}`;
                } else if (nameStr) {
                    return nameStr; // Fallback to just name if no is missing
                } else if (numStr) {
                    return numStr; // Fallback to just no if name is missing
                } else {
                    return ''; // Should not happen if validation works, but safe fallback
                }
            }

            // --- Core Logic Functions ---
            async function handleUrlLoad() {
                const url = urlInput.value.trim();
                if (!url) {
                    alert("Please paste a Google Sheet 'Publish to web' CSV URL first.");
                    return;
                }
                 if (!url.includes('/pub?') || !url.includes('output=csv')) {
                     console.warn("URL format might be incorrect. Expected a Google Sheet 'Publish to web' CSV link. Attempting to load anyway...");
                 }

                setLoadingState(true);
                hierarchy.clear(); // Clear previous hierarchy
                psCandidateData.clear(); // Clear previous candidate data
                headerMap = {}; // Clear previous headers

                try {
                    console.log("Fetching URL with cache: 'no-store'");
                    const response = await fetch(url, { cache: 'no-store' });

                    if (!response.ok) {
                        throw new Error(`Failed to fetch. Status: ${response.status} ${response.statusText}. Check URL & permissions.`);
                    }
                    const csvText = await response.text();
                    if (!csvText) {
                         throw new Error("Fetched data is empty.");
                    }

                    // Parse CSV using SheetJS
                    const workbook = XLSX.read(csvText, { type: 'string', raw: true });
                    const sheetName = workbook.SheetNames[0];
                    if (!sheetName) throw new Error("Could not parse CSV data.");
                    rawData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { defval: null }); // Use null for empty values
                     if (!rawData.length) throw new Error("CSV data is empty after parsing.");

                    // Find actual header keys (case-insensitive)
                    const headers = Object.keys(rawData[0] || {});
                    let missingKeys = [];
                    headerMap = {}; // Reset header map before finding new ones
                    REQ_KEYS.forEach(key => {
                        const foundKey = findHeaderKey(headers, key);
                        if (foundKey) {
                            headerMap[key] = foundKey;
                        } else {
                            missingKeys.push(key.toUpperCase());
                        }
                    });

                    if (missingKeys.length > 0) {
                        throw new Error(`Required columns not found: ${missingKeys.join(', ')}`);
                    }

                    // Process data into hierarchy AND extract candidate data
                    processData();

                    // Populate the first dropdown
                    populateZpcDropdown();
                    statusLabel.textContent = `Loaded ${rawData.length} rows. Select ZPC to begin.`;

                } catch (error) {
                     console.error("Loading error:", error);
                     statusLabel.textContent = `Error: ${error.message}`;
                     alert(`Loading Error:\n${error.message}`);
                     resetAllDropdowns(); // Reset on error
                } finally {
                    setLoadingState(false);
                }
            }

             function processData() {
                 hierarchy.clear(); // Ensure it's empty before processing
                 psCandidateData.clear(); // Clear candidate data map too

                 const processedPsNames = new Set(); // To handle potential duplicates if hierarchy levels are identical but candidates differ

                 rawData.forEach(row => {
                     // Get hierarchy keys
                     const zpcName = formatNoName(row[headerMap[ZPC_NO_KEY]], row[headerMap[ZPC_KEY]]);
                     const apName = formatNoName(row[headerMap[AP_NO_KEY]], row[headerMap[AP_KEY]]);
                     const gpName = formatNoName(row[headerMap[GP_NO_KEY]], row[headerMap[GP_KEY]]);
                     const wardName = formatNoName(row[headerMap[WARD_NO_KEY]], row[headerMap[WARD_KEY]]);
                     const psName = formatNoName(row[headerMap[PS_NO_KEY]], row[headerMap[PS_KEY]]);

                     // Build Hierarchy (only if all levels have names)
                     if (zpcName && apName && gpName && wardName && psName) {
                         if (!hierarchy.has(zpcName)) hierarchy.set(zpcName, new Map());
                         const zpcMap = hierarchy.get(zpcName);

                         if (!zpcMap.has(apName)) zpcMap.set(apName, new Map());
                         const apMap = zpcMap.get(apName);

                         if (!apMap.has(gpName)) apMap.set(gpName, new Map());
                         const gpMap = apMap.get(gpName);

                         if (!gpMap.has(wardName)) gpMap.set(wardName, new Set());
                         const wardSet = gpMap.get(wardName);

                         wardSet.add(psName);

                         // Store Candidate Data (using the formatted psName as the key)
                         // Only store the first occurrence if duplicate PS names exist within the hierarchy
                         if (!processedPsNames.has(psName)) {
                             const candidates = {
                                 zpc: getCandidateNamesJS(row, ZPC_CANDIDATE_PREFIX),
                                 ap: getCandidateNamesJS(row, AP_CANDIDATE_PREFIX),
                                 ward: getCandidateNamesJS(row, WARD_CANDIDATE_PREFIX)
                             };
                             psCandidateData.set(psName, candidates);
                             processedPsNames.add(psName);
                              // console.log(`Stored candidates for PS: ${psName}`, candidates);
                         }
                     } else {
                        // Optionally log skipped rows
                         // console.warn("Skipping row due to missing hierarchy name(s):", row);
                     }
                 });
                 console.log("Hierarchy built:", hierarchy); // For debugging
                 console.log("Candidate data mapped:", psCandidateData); // For debugging
             }

            // --- Dropdown Population and Handling ---

            function populateZpcDropdown() {
                const zpcNames = Array.from(hierarchy.keys());
                populateDropdown(zpcSelect, zpcNames, 'Select ZPC');
                resetDropdown(apSelect, 'Select AP');
                resetDropdown(gpSelect, 'Select GP');
                resetDropdown(wardSelect, 'Select Ward');
                resetDropdown(psSelect, 'Select PS'); // This calls clearAndHideCandidates implicitly
            }

            function handleZpcChange() {
                const selectedZpc = zpcSelect.value;
                resetDropdown(apSelect, 'Select AP');
                resetDropdown(gpSelect, 'Select GP');
                resetDropdown(wardSelect, 'Select Ward');
                resetDropdown(psSelect, 'Select PS'); // Clears subsequent dropdowns and candidates

                if (selectedZpc && hierarchy.has(selectedZpc)) {
                    const apMap = hierarchy.get(selectedZpc);
                    const apNames = Array.from(apMap.keys());
                    populateDropdown(apSelect, apNames, 'Select AP');
                }
            }

             function handleApChange() {
                 const selectedZpc = zpcSelect.value;
                 const selectedAp = apSelect.value;
                 resetDropdown(gpSelect, 'Select GP');
                 resetDropdown(wardSelect, 'Select Ward');
                 resetDropdown(psSelect, 'Select PS'); // Clears subsequent dropdowns and candidates

                 if (selectedZpc && selectedAp && hierarchy.has(selectedZpc) && hierarchy.get(selectedZpc).has(selectedAp)) {
                     const gpMap = hierarchy.get(selectedZpc).get(selectedAp);
                     const gpNames = Array.from(gpMap.keys());
                     populateDropdown(gpSelect, gpNames, 'Select GP');
                 }
             }

              function handleGpChange() {
                 const selectedZpc = zpcSelect.value;
                 const selectedAp = apSelect.value;
                 const selectedGp = gpSelect.value;
                 resetDropdown(wardSelect, 'Select Ward');
                 resetDropdown(psSelect, 'Select PS'); // Clears subsequent dropdowns and candidates

                  if (selectedZpc && selectedAp && selectedGp &&
                      hierarchy.has(selectedZpc) &&
                      hierarchy.get(selectedZpc).has(selectedAp) &&
                      hierarchy.get(selectedZpc).get(selectedAp).has(selectedGp)) {
                     const wardMap = hierarchy.get(selectedZpc).get(selectedAp).get(selectedGp);
                     const wardNames = Array.from(wardMap.keys());
                     populateDropdown(wardSelect, wardNames, 'Select Ward');
                 }
             }

             function handleWardChange() {
                 const selectedZpc = zpcSelect.value;
                 const selectedAp = apSelect.value;
                 const selectedGp = gpSelect.value;
                 const selectedWard = wardSelect.value;
                 resetDropdown(psSelect, 'Select PS'); // Clears subsequent dropdowns and candidates

                 if (selectedZpc && selectedAp && selectedGp && selectedWard &&
                     hierarchy.has(selectedZpc) &&
                     hierarchy.get(selectedZpc).has(selectedAp) &&
                     hierarchy.get(selectedZpc).get(selectedAp).has(selectedGp) &&
                     hierarchy.get(selectedZpc).get(selectedAp).get(selectedGp).has(selectedWard)) {
                    const psSet = hierarchy.get(selectedZpc).get(selectedAp).get(selectedGp).get(selectedWard);
                    const psNames = Array.from(psSet);
                    populateDropdown(psSelect, psNames, 'Select PS');
                 }
             }

             // --- Candidate Display Logic ---

             function handlePsSelectChange() {
                 const selectedPs = psSelect.value;
                 if (selectedPs && psCandidateData.has(selectedPs)) {
                     const candidates = psCandidateData.get(selectedPs);
                     displayCandidates(candidates);
                 } else {
                     clearAndHideCandidates();
                 }
             }

             function displayCandidates(candidates) {
                 if (!candidates) {
                    clearAndHideCandidates();
                    return;
                 }
                 // Helper to populate a single list
                 const populateList = (listElement, candidateArray) => {
                     listElement.innerHTML = ''; // Clear previous items
                     if (candidateArray && candidateArray.length > 0) {
                         candidateArray.forEach(name => {
                             const li = document.createElement('li');
                             li.textContent = name;
                             listElement.appendChild(li);
                         });
                     } else {
                         const li = document.createElement('li');
                         li.textContent = 'Uncontested or Nil';
                         li.classList.add('uncontested');
                         listElement.appendChild(li);
                     }
                 };

                 populateList(zpcCandidateList, candidates.zpc);
                 populateList(apCandidateList, candidates.ap);
                 populateList(wardCandidateList, candidates.ward);

                 candidateDisplayDiv.classList.remove('hidden'); // Show the display area
             }

             function clearAndHideCandidates() {
                 zpcCandidateList.innerHTML = '';
                 apCandidateList.innerHTML = '';
                 wardCandidateList.innerHTML = '';
                 candidateDisplayDiv.classList.add('hidden'); // Hide the display area
             }

            // --- Initial State ---
            resetAllDropdowns(); // Includes clearing/hiding candidates

        }); // End DOMContentLoaded
    </script>
</body>
</html>